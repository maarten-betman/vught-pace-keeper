{% extends "base.html" %}
{% load training_tags %}

{% block title %}Dashboard - Vught Pace Keeper{% endblock %}

{% block content %}
<h1 class="text-2xl font-bold mb-6">Welcome, {{ user.first_name|default:user.username }}!</h1>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Strava Sync Widget -->
    <div hx-get="{% url 'strava:status' %}" hx-trigger="load" hx-swap="innerHTML">
        <!-- Loading state -->
        <div class="card animate-pulse h-full">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gray-200 rounded-lg"></div>
                    <div>
                        <div class="h-4 bg-gray-200 rounded w-24 mb-2"></div>
                        <div class="h-3 bg-gray-200 rounded w-32"></div>
                    </div>
                </div>
                <div class="h-10 bg-gray-200 rounded w-24"></div>
            </div>
        </div>
    </div>

    <!-- This Week Stats -->
    <div class="card">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold">This Week</h3>
            <a href="{% url 'training:analytics_dashboard' %}" class="text-strava text-sm hover:underline">
                View Analytics &rarr;
            </a>
        </div>
        <div class="grid grid-cols-3 gap-4 text-center">
            <div>
                <div class="text-2xl font-bold text-strava">{{ weekly_summary.actual_distance_km|floatformat:1 }}</div>
                <div class="text-xs text-gray-500 uppercase">km</div>
            </div>
            <div>
                <div class="text-2xl font-bold">{{ weekly_summary.workouts_completed }}</div>
                <div class="text-xs text-gray-500 uppercase">workouts</div>
            </div>
            <div>
                <div class="text-2xl font-bold">
                    {% if weekly_summary.average_pace %}{{ weekly_summary.average_pace|format_pace }}{% else %}-{% endif %}
                </div>
                <div class="text-xs text-gray-500 uppercase">avg pace</div>
            </div>
        </div>
        {% if weekly_summary.workouts_completed == 0 %}
        <p class="text-center text-gray-500 text-sm mt-4">
            No workouts logged this week.
            <a href="{% url 'training:workout_log_manual' %}" class="text-strava hover:underline">Log one now</a>
        </p>
        {% endif %}
    </div>
</div>

<!-- Unmatched Workouts Alert -->
{% if unmatched_count > 0 %}
<div class="card border-orange-200 bg-orange-50 mb-6">
    <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
                <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                </svg>
            </div>
            <div>
                <div class="font-semibold text-gray-900">
                    {{ unmatched_count }} Unmatched Workout{{ unmatched_count|pluralize }}
                </div>
                <div class="text-sm text-gray-600">
                    Link to your training plan for better progress tracking
                </div>
            </div>
        </div>
        <a href="{% url 'training:matching' %}" class="btn btn-strava text-sm py-2 px-4">
            Match Now
        </a>
    </div>
</div>
{% endif %}

<section class="mb-8">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">Your Training Plans</h2>
        <a href="{% url 'training:plan_list' %}" class="text-strava hover:text-strava-dark text-sm">
            View All &rarr;
        </a>
    </div>

    {% if training_plans %}
    <div class="grid gap-4">
        {% for plan in training_plans|slice:":3" %}
        <a href="{% url 'training:plan_detail' pk=plan.pk %}" class="card hover:border-strava transition-colors">
            <h3 class="font-semibold mb-1">{{ plan.name }}</h3>
            <p class="text-gray-500 text-sm">
                {{ plan.get_plan_type_display }} &bull; {{ plan.duration_weeks }} weeks
                {% if plan.target_race_date %}
                &bull; Race: {{ plan.target_race_date|date:"M j, Y" }}
                {% endif %}
            </p>
        </a>
        {% endfor %}
    </div>
    {% else %}
    <div class="card text-center py-8">
        <p class="text-gray-500 mb-4">You don't have any training plans yet.</p>
        <a href="{% url 'training:plan_create' %}" class="btn btn-strava">Create Your First Plan</a>
    </div>
    {% endif %}
</section>

{% if template_plans %}
<section>
    <h2 class="text-xl font-semibold mb-4">Quick Start Templates</h2>
    <div class="grid gap-4">
        {% for plan in template_plans|slice:":2" %}
        <div class="card">
            <div class="flex justify-between items-start">
                <div>
                    <h3 class="font-semibold">{{ plan.name }}</h3>
                    <p class="text-gray-500 text-sm">
                        {{ plan.get_plan_type_display }} &bull; {{ plan.duration_weeks }} weeks
                        {% if plan.goal_time %}
                        &bull; Goal: {{ plan.goal_time }}
                        {% endif %}
                    </p>
                </div>
                <a href="{% url 'training:plan_copy' pk=plan.pk %}" class="btn btn-strava text-sm py-2 px-4">
                    Use Template
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}
{% endblock %}
