{% extends "base.html" %}

{% block title %}Match Workouts - Vught Pace Keeper{% endblock %}

{% block content %}
<div class="mb-6 flex items-center justify-between">
    <div>
        <h1 class="text-2xl font-bold text-gray-900">Match Workouts</h1>
        <p class="text-gray-600 mt-1">
            Link completed workouts to your training plan
            {% if unmatched_count > 0 %}
            <span class="ml-2 px-2 py-0.5 bg-orange-100 text-orange-800 rounded-full text-sm font-medium">
                {{ unmatched_count }} unmatched
            </span>
            {% endif %}
        </p>
    </div>
    {% if unmatched_count > 0 %}
    <form method="post" action="{% url 'training:auto_match' %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-secondary">
            Auto-Match All
        </button>
    </form>
    {% endif %}
</div>

{% if workouts_with_candidates %}
<div class="space-y-4">
    {% for item in workouts_with_candidates %}
    <div id="workout-row-{{ item.workout.pk }}" class="card">
        <div class="flex items-start justify-between">
            <!-- Workout Info -->
            <div class="flex-1">
                <div class="flex items-center gap-3 mb-2">
                    <span class="text-sm text-gray-500">{{ item.workout.date|date:"D, M j, Y" }}</span>
                    {% if item.workout.source == "strava" %}
                    <span class="flex items-center gap-1 text-xs text-strava">
                        <svg class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066l-2.084 4.116z"/>
                            <path d="M10.298 13.828l2.089-4.116h3.065L10.298 0l-5.15 10.172h3.066l2.084-4.116z" opacity=".6"/>
                        </svg>
                        Strava
                    </span>
                    {% endif %}
                </div>

                <div class="grid grid-cols-3 gap-4 text-sm">
                    <div>
                        <span class="text-gray-500">Distance:</span>
                        <span class="font-medium">{{ item.workout.actual_distance_km }} km</span>
                    </div>
                    <div>
                        <span class="text-gray-500">Duration:</span>
                        <span class="font-medium">{{ item.workout.actual_duration }}</span>
                    </div>
                    <div>
                        <span class="text-gray-500">Pace:</span>
                        <span class="font-medium">{{ item.workout.average_pace_min_per_km }} min/km</span>
                    </div>
                </div>

                {% if item.workout.notes %}
                <p class="text-sm text-gray-600 mt-2">{{ item.workout.notes|truncatewords:15 }}</p>
                {% endif %}
            </div>

            <!-- Match Actions -->
            <div class="ml-4 text-right">
                {% if item.best_match %}
                <div class="mb-2">
                    <span class="text-xs text-gray-500">Best match:</span>
                    <div class="text-sm font-medium text-gray-900">
                        {{ item.best_match.scheduled_workout.get_workout_type_display }}
                    </div>
                    <div class="text-xs text-gray-500">
                        {{ item.best_match.reason }}
                    </div>
                    <div class="flex items-center justify-end gap-1 mt-1">
                        <span class="text-xs text-gray-500">Score:</span>
                        <span class="px-1.5 py-0.5 rounded text-xs font-medium
                            {% if item.best_match.score >= 0.8 %}bg-green-100 text-green-800
                            {% elif item.best_match.score >= 0.5 %}bg-yellow-100 text-yellow-800
                            {% else %}bg-gray-100 text-gray-800
                            {% endif %}">
                            {{ item.best_match.score|floatformat:0|stringformat:"d" }}%
                        </span>
                    </div>
                </div>
                {% endif %}

                <div class="flex gap-2 justify-end">
                    {% if item.best_match and item.best_match.score >= 0.5 %}
                    <form method="post"
                          action="{% url 'training:match_workout' item.workout.pk item.best_match.scheduled_workout.pk %}"
                          hx-post="{% url 'training:match_workout' item.workout.pk item.best_match.scheduled_workout.pk %}"
                          hx-target="#workout-row-{{ item.workout.pk }}"
                          hx-swap="outerHTML">
                        {% csrf_token %}
                        <button type="submit" class="text-sm px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600">
                            Match
                        </button>
                    </form>
                    {% endif %}

                    <button type="button"
                            class="text-sm px-3 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200"
                            hx-get="{% url 'training:match_candidates' item.workout.pk %}"
                            hx-target="#candidates-{{ item.workout.pk }}"
                            hx-swap="innerHTML">
                        More Options
                    </button>
                </div>
            </div>
        </div>

        <!-- Expandable Candidates List -->
        <div id="candidates-{{ item.workout.pk }}" class="mt-4">
            <!-- Loaded via HTMX when "More Options" clicked -->
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="card text-center py-12">
    <svg class="w-16 h-16 mx-auto text-green-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
    </svg>
    <h3 class="text-lg font-medium text-gray-900 mb-2">All workouts matched!</h3>
    <p class="text-gray-500">No unmatched workouts found.</p>
    <a href="{% url 'training:workout_log_list' %}" class="btn btn-secondary mt-4">
        View Workout Log
    </a>
</div>
{% endif %}

<!-- Info Section -->
<div class="mt-6 p-4 bg-blue-50 rounded-lg text-sm text-blue-800">
    <h3 class="font-semibold mb-2">About Workout Matching</h3>
    <ul class="space-y-1 list-disc list-inside">
        <li>Match scores are based on date proximity (60%) and distance similarity (40%)</li>
        <li>Workouts within 3 days of a scheduled workout can be matched</li>
        <li>Auto-match will link workouts with a score of 70% or higher</li>
        <li>Manual matching allows you to choose any available scheduled workout</li>
    </ul>
</div>
{% endblock %}
